{% extends 'base.html' %}
{% block title %}RestaurantSenac{% endblock %}
{% block content %}
<div class="text-center mb-5">
    <h2 class="text-orange mb-3">Cardápio</h2>
    <p class="text-light">Conheça nossos pratos deliciosos</p>
</div>


<ul class="nav nav-pills justify-content-center mb-4" id="pills-tab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="pills-menu-tab" data-bs-toggle="pill" data-bs-target="#pills-menu"
            type="button" role="tab" aria-controls="pills-menu" aria-selected="true" onclick="checkMesaStrict()">
            <i class="bi bi-journal-text me-2"></i>Cardápio
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link position-relative" id="pills-cart-tab" data-bs-toggle="pill"
            data-bs-target="#pills-cart" type="button" role="tab" aria-controls="pills-cart" aria-selected="false"
            onclick="renderCart()">
            <i class="bi bi-cart3 me-2"></i>Carrinho
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                id="cart-badge" style="display: none;">
                0
            </span>
        </button>
    </li>
</ul>

<div class="tab-content" id="pills-tabContent">
    <!-- Tab Cardápio -->
    <div class="tab-pane fade show active" id="pills-menu" role="tabpanel" aria-labelledby="pills-menu-tab">
        <div class="row g-4">
            {% for prato in pratos %}
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-0 shadow-sm bg-dark text-light">
                    {% if prato.imagem %}
                    <img src="{{ prato.imagem.url }}" class="card-img-top" alt="{{ prato.nome }}"
                        style="height: 200px; object-fit: cover; opacity: 0.9;">
                    {% else %}
                    <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center"
                        style="height: 200px;">
                        <i class="bi bi-camera fs-1 text-white-50"></i>
                    </div>
                    {% endif %}
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title text-orange mb-0">{{ prato.nome }}</h5>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-orange text-dark">{{ prato.get_categoria_display }}</span>
                                {% if user.is_authenticated %}
                                <form action="{% url 'prato_delete' prato.pk %}" method="post" class="d-inline"
                                    onsubmit="return confirm('Tem certeza que deseja excluir o prato {{ prato.nome }}?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-link text-danger p-0 border-0"
                                        title="Excluir">
                                        <i class="bi bi-trash-fill fs-5"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                        <p class="card-text flex-grow-1 text-light small opacity-75">{{ prato.descricao }}</p>

                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <span class="fs-5 fw-bold text-orange">R$ {{ prato.preco }}</span>

                            <!-- Controles do Carrinho -->
                            <div class="d-flex align-items-center bg-secondary rounded p-1">
                                <button class="btn btn-sm btn-outline-light border-0"
                                    onclick='updateCart("{{ prato.id }}", "remove", "{{ prato.nome|escapejs }}", "{{ prato.preco|floatformat:2 }}")'>
                                    <i class="bi bi-dash"></i>
                                </button>
                                <span class="mx-3 fw-bold" id="counter-{{ prato.id }}">0</span>
                                <button class="btn btn-sm btn-outline-light border-0"
                                    onclick='updateCart("{{ prato.id }}", "add", "{{ prato.nome|escapejs }}", "{{ prato.preco|floatformat:2 }}")'>
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center py-5">
                <p class="text-muted fs-4">Cardápio em atualização. Volte em breve!</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Tab Carrinho -->
    <div class="tab-pane fade" id="pills-cart" role="tabpanel" aria-labelledby="pills-cart-tab">
        <div class="card bg-dark border-secondary">
            <div class="card-body">
                <h4 class="card-title text-orange mb-4">Seu Pedido</h4>
                <div class="table-responsive">
                    <table class="table table-dark table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th class="text-center">Qtd</th>
                                <th class="text-end">Preço Unit.</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody id="cart-table-body">
                            <!-- Items serão inseridos aqui via JS -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end fw-bold fs-5">Total Geral:</td>
                                <td class="text-end fw-bold fs-5 text-orange" id="cart-total-value">R$ 0,00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="text-center mt-4" id="cart-actions">
                    <p class="text-muted" id="cart-empty-msg">Seu carrinho está vazio.</p>
                    <button class="btn btn-orange btn-lg px-5 fw-bold" id="btn-send-order" style="display: none;"
                        onclick="sendOrder()">
                        <i class="bi bi-whatsapp me-2"></i>Enviar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Mesa - Backdrop static prevents closing without selection -->
<div class="modal fade" id="mesaModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="mesaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="mesaModalLabel">Bem-vindo!</h5>
            </div>
            <div class="modal-body">
                <p>Por favor, informe o número da sua mesa para continuar.</p>
                <div class="mb-3">
                    <label for="mesaInput" class="form-label">Número da Mesa</label>
                    <input type="number" class="form-control bg-secondary text-light border-0" id="mesaInput"
                        placeholder="Ex: 5" min="1">
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-orange w-100" onclick="saveMesa()">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast align-items-center text-white bg-success border-0" role="alert"
        aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toast-message">
                <!-- Mensagem aqui -->
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
</div>

<script>
    // Estado do Carrinho
    let cart = {}; // { id: { name, price, qty } }

    document.addEventListener('DOMContentLoaded', function () {
        checkMesaStrict();
    });

    function checkMesaStrict() {
        // Always show modal if we are on the menu tab
        const menuTab = document.getElementById('pills-menu');
        if (menuTab.classList.contains('active')) {
            const modalEl = document.getElementById('mesaModal');
            // Check if modal instance already exists/is shown
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();

            // Populate input if value exists
            const savedMesa = sessionStorage.getItem('mesa_id');
            if (savedMesa) {
                document.getElementById('mesaInput').value = savedMesa;
            }
        }
    }

    function saveMesa() {
        const input = document.getElementById('mesaInput');
        const mesa = input.value;
        if (mesa && mesa > 0) {
            sessionStorage.setItem('mesa_id', mesa);
            const modalEl = document.getElementById('mesaModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            showToast(`Mesa ${mesa} registrada!`);
        } else {
            alert('Por favor, insira um número de mesa válido.');
        }
    }

    function updateCart(id, action, name, price) {
        // Inicializa item se não existir
        if (!cart[id]) {
            cart[id] = { name: name, price: parseFloat(price), qty: 0, id: id };
        }

        if (action === 'add') {
            cart[id].qty++;
            showToast('Adicionado ao carrinho.');
        } else if (action === 'remove') {
            if (cart[id].qty > 0) {
                cart[id].qty--;
            }
        }

        // Limpeza se qtd for 0
        if (cart[id].qty === 0) {
            delete cart[id];
            // Reseta contador visualmente se existir
            const counterEl = document.getElementById(`counter-${id}`);
            if (counterEl) counterEl.innerText = '0';
        } else {
            // Atualiza contador visual
            const counterEl = document.getElementById(`counter-${id}`);
            if (counterEl) counterEl.innerText = cart[id].qty;
        }

        updateCartBadge();
    }

    function updateCartBadge() {
        let totalQty = 0;
        for (let key in cart) {
            totalQty += cart[key].qty;
        }

        const badge = document.getElementById('cart-badge');
        if (totalQty > 0) {
            badge.innerText = totalQty;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }

    function renderCart() {
        const tbody = document.getElementById('cart-table-body');
        const totalEl = document.getElementById('cart-total-value');
        const emptyMsg = document.getElementById('cart-empty-msg');
        const sendBtn = document.getElementById('btn-send-order');

        tbody.innerHTML = '';
        let grandTotal = 0;
        let hasItems = false;

        for (let id in cart) {
            const item = cart[id];
            if (item.qty > 0) {
                hasItems = true;
                const totalItem = item.qty * item.price;
                grandTotal += totalItem;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td class="text-center">${item.qty}</td>
                    <td class="text-end">R$ ${item.price.toFixed(2).replace('.', ',')}</td>
                    <td class="text-end">R$ ${totalItem.toFixed(2).replace('.', ',')}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        totalEl.innerText = `R$ ${grandTotal.toFixed(2).replace('.', ',')}`;

        if (hasItems) {
            emptyMsg.style.display = 'none';
            sendBtn.style.display = 'inline-block';
        } else {
            emptyMsg.style.display = 'block';
            sendBtn.style.display = 'none';
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function sendOrder() {
        const mesa = sessionStorage.getItem('mesa_id');
        if (!mesa) {
            alert('Erro: Mesa não identificada. Por favor recarregue a página.');
            checkMesa();
            return;
        }

        const itens = [];
        for (let id in cart) {
            if (cart[id].qty > 0) {
                itens.push({
                    id: id,
                    qty: cart[id].qty
                });
            }
        }

        if (itens.length === 0) return;

        const data = {
            mesa: mesa,
            itens: itens
        };

        const csrftoken = getCookie('csrftoken');

        fetch('/api/pedido/novo/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (!response.ok) throw new Error('Erro ao enviar pedido');
                return response.json();
            })
            .then(result => {
                // Limpar carrinho
                cart = {};
                // Resetar contadores na aba Cardápio
                const counters = document.querySelectorAll('[id^="counter-"]');
                counters.forEach(c => c.innerText = "0");
                // Resetar Badge
                updateCartBadge();
                // Renderizar (limpar lista)
                renderCart();
                // Notificação
                showToast('Pedido enviado com sucesso!');
                // Opcional: Voltar para aba cardápio
                const menuTab = new bootstrap.Tab(document.querySelector('#pills-menu-tab'));
                menuTab.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ocorreu um erro ao enviar o pedido. Tente novamente.');
            });
    }

    function showToast(message) {
        const toastEl = document.getElementById('liveToast');
        const toastBody = document.getElementById('toast-message');
        toastBody.innerText = message;
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
</script>

{% endblock %}